<script>
document.addEventListener("DOMContentLoaded", async () => {

  const params = new URLSearchParams(window.location.search);
  const PRODUCT_ID = params.get("id");
  if (!PRODUCT_ID) { location.href = "index.html"; return; }

  const response = await fetch("products.csv");
  const csv = await response.text();

  const lines = csv.split("\n").map(l=>l.trim()).filter(Boolean);
  const headers = lines.shift().split(";");
  const products = lines.map(line=>{
    const values=line.split(";");
    let o={}; headers.forEach((h,i)=>o[h]=values[i]); return o;
  });

  const product = products.find(p=>p.id===PRODUCT_ID);
  if(!product) return;

  /* ===== SEO ===== */
  document.title = product.seo_title_en;
  document.querySelector("meta[name='description']").content = product.seo_description_en;
  document.querySelector("meta[property='og:title']").content = product.seo_title_en;
  document.querySelector("meta[property='og:description']").content = product.seo_description_en;
  document.querySelector("meta[property='og:image']").content =
    `https://www.donbriz-lighting.com/images/product${PRODUCT_ID}-1.png`;

  const canonical =
    `https://www.donbriz-lighting.com/card.html?id=${PRODUCT_ID}`;
  document.getElementById("canonical-link").href = canonical;

  /* ===== SCHEMA.ORG ===== */
  const schema = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.title_en,
    "description": product.seo_description_en,
    "image": [`https://www.donbriz-lighting.com/images/product${PRODUCT_ID}-1.png`],
    "sku": product.id,
    "manufacturer": {
      "@type": "Organization",
      "name": product.manufacturer
    },    
    "offers": {
      "@type": "Offer",
      "url": canonical,
      "priceCurrency": "EUR",
      /* "price": product.sale_price, */  // <--- восстановлено
      "availability": "https://schema.org/InStock",
      "itemCondition": "https://schema.org/UsedCondition"
    }
  };
  
  document.getElementById("schema-product").textContent =
    JSON.stringify(schema);

  const breadcrumb = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Collection", "item": "https://www.donbriz-lighting.com/" },
      { "@type": "ListItem", "position": 2, "name": product.title_en, "item": canonical }
    ]
  };
  document.getElementById("schema-breadcrumb").textContent =
    JSON.stringify(breadcrumb);

  /* ===== CONTENT ===== */
  document.getElementById("title").textContent = product.title_en;
  document.getElementById("subtitle").textContent = product.subtitle_en;
  document.getElementById("description").textContent = product.description_en;
  document.getElementById("manufacturer").textContent = product.manufacturer;
  document.getElementById("style").textContent = product.style;
  document.getElementById("materials").innerHTML = product.materials.replace(/\\n/g,"<br>");
  document.getElementById("detailed_condition").textContent = product.detailed_condition;
  document.getElementById("sale_price").textContent = product.sale_price;
  document.getElementById("specs").innerHTML =
    `Diameter: ${product.diameter} cm<br>
     Height: ${product.height} cm<br>
     Weight: ${product.weight} kg<br>
     Lamps: ${product.lamps}`;
  document.getElementById("requestBtn").href = `request.html?id=${PRODUCT_ID}`;

  /* ===== GALLERY ===== */
  const mainImage = document.getElementById("mainImage");
  const thumbs = document.getElementById("thumbnails");
  const viewer = document.getElementById("imageViewer");
  const viewerImg = document.getElementById("viewerImage");

  mainImage.onclick = () => {
    viewerImg.src = mainImage.src;
    viewer.classList.remove("hidden");
  };
  viewer.onclick = () => viewer.classList.add("hidden");

  const imageSources = [];
  let firstLoaded = false;

  // Загружаем миниатюры, проверяем существование изображений
  for (let i = 1; i <= 10; i++) {
    const src = `images/product${PRODUCT_ID}-${i}.png`;
    const img = new Image();
    img.onload = () => {
      imageSources.push(src); // только реально существующие изображения
      const t = document.createElement("img");
      t.src = src;
      if (!firstLoaded) {
        mainImage.src = src;
        t.classList.add("active");
        currentIndex = 0;
        firstLoaded = true;
      }
      t.onclick = () => {
        currentIndex = imageSources.indexOf(src);
        showImage(currentIndex);
      };
      thumbs.appendChild(t);
    };
    img.onerror = () => {
      // Если изображения нет, просто пропускаем
      console.warn(`Image not found: ${src}`);
    };
    img.src = src;
  }

  /* ===== IMAGE NAVIGATION ===== */
  let currentIndex = 0;

  function showImage(index) {
    if (imageSources.length === 0) return;
    if (index < 0) index = imageSources.length - 1;
    if (index >= imageSources.length) index = 0;
    currentIndex = index;
    mainImage.src = imageSources[index];
    // обновляем активный thumbnail
    thumbs.querySelectorAll("img").forEach((img, idx) => {
      img.classList.toggle("active", imageSources[idx] === imageSources[index]);
    });
  }

  document.getElementById("prevBtn").onclick = () => showImage(currentIndex - 1);
  document.getElementById("nextBtn").onclick = () => showImage(currentIndex + 1);

});
</script>
